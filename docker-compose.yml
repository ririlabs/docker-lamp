version: "3.4"

services:
  apache:
    image: silkrad/apache:latest
    build: 
      context: ./src/apache
    env_file:
      - ./config/apache/apache.env
    ports:
      - "80:8080"
      - "443:8443"
    volumes:
      - apache-www:/var/www/
      - apache-log:/var/log/apache2/
    secrets:
      - source: ca.cert
        target: /secrets/ca.cert
      - source: vhost.cert
        target: /secrets/vhost.cert
      - source: vhost.key
        target: /secrets/vhost.key
  mysql:
    image: silkrad/mysql:latest
    build:
      context: ./src/mysql
    env_file:
      - ./config/mysql/mysql.env
    volumes:
      - mysql-data:/var/lib/mysql
      - mysql-log:/var/log/mysql

secrets:
  ca.cert:
    file: ./config/apache/ca.cert
  vhost.cert:
    file: ./config/apache/vhost.cert
  vhost.key:
    file: ./config/apache/vhost.key
  mysqlpw:
    file: ./config/mysql/mysqlpw

volumes:
  apache-www:
  apache-log:
  mysql-data:
  mysql-log: